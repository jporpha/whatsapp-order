<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Panel Administrador - WhatsApp Order</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
  <style>
    body { padding: 20px; }
    .section { margin-bottom: 40px; }
    table td, table th { vertical-align: middle; }
  </style>
</head>
<body>
<h1>Panel de Administración</h1>

<!-- Settings -->
<div class="section">
  <h2>Configuración de la tienda</h2>
  <form id="settingsForm" class="row g-3">
    <div class="col-md-4">
      <label class="form-label">Nombre de la tienda</label>
      <input type="text" class="form-control" id="storeName" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Teléfono administrador</label>
      <input type="text" class="form-control" id="adminPhone" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Moneda</label>
      <input type="text" class="form-control" id="currency" required>
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-primary">Guardar</button>
    </div>
  </form>
</div>

<!-- Productos -->
<div class="section">
  <h2>Productos</h2>
  <form id="productForm" class="row g-3">
    <input type="hidden" id="productId">
    <div class="col-md-3">
      <input type="text" class="form-control" id="pName" placeholder="Nombre" required>
    </div>
    <div class="col-md-3">
      <input type="text" class="form-control" id="pDescription" placeholder="Descripción">
    </div>
    <div class="col-md-2">
      <input type="number" step="0.01" class="form-control" id="pPrice" placeholder="Precio" required>
    </div>
    <div class="col-md-2">
      <input type="text" class="form-control" id="pCurrency" placeholder="Moneda" required>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-success w-100">Agregar/Actualizar</button>
    </div>
  </form>
  <table class="table table-striped mt-3">
    <thead>
    <tr>
      <th>Nombre</th><th>Descripción</th><th>Precio</th><th>Moneda</th><th>Disponible</th><th>Acciones</th>
    </tr>
    </thead>
    <tbody id="productTable"></tbody>
  </table>
</div>

<!-- Plantillas -->
<div class="section">
  <h2>Plantillas de Mensaje</h2>
  <form id="templateForm" class="row g-3">
    <input type="hidden" id="templateId">
    <div class="col-md-3">
      <input type="text" class="form-control" id="tName" placeholder="Nombre" required>
    </div>
    <div class="col-md-7">
      <textarea class="form-control" id="tText" placeholder="Texto de plantilla" rows="2" required></textarea>
    </div>
    <div class="col-md-2">
      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="tActive">
        <label class="form-check-label">Activa</label>
      </div>
      <button type="submit" class="btn btn-success w-100 mt-1">Guardar</button>
    </div>
  </form>
  <table class="table table-striped mt-3">
    <thead>
    <tr><th>Nombre</th><th>Texto</th><th>Activa</th><th>Acciones</th></tr>
    </thead>
    <tbody id="templateTable"></tbody>
  </table>
</div>

<script>
  const apiBase = '/api/v1';

  // SETTINGS
  async function loadSettings(){
    const res = await fetch(apiBase + '/admin/settings');
    const s = await res.json();
    document.getElementById('storeName').value = s.storeName;
    document.getElementById('adminPhone').value = s.adminPhone;
    document.getElementById('currency').value = s.currency;
  }
  document.getElementById('settingsForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const body = {
      storeName: storeName.value,
      adminPhone: adminPhone.value,
      currency: currency.value
    };
    await fetch(apiBase + '/admin/settings', {
      method: 'PUT', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    alert('Configuración guardada');
  });

  // PRODUCTOS
  async function loadProducts(){
    const res = await fetch(apiBase + '/products');
    const products = await res.json();
    const tbody = document.getElementById('productTable');
    tbody.innerHTML = '';
    products.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.name}</td><td>${p.description||''}</td>
                    <td>${p.price}</td><td>${p.currency}</td>
                    <td>${p.available?'Sí':'No'}</td>
                    <td>
                      <button class="btn btn-sm btn-warning" onclick='editProduct(${JSON.stringify(p)})'>Editar</button>
                      <button class="btn btn-sm btn-danger" onclick='deleteProduct(${p.id})'>Eliminar</button>
                    </td>`;
      tbody.appendChild(tr);
    });
  }
  function editProduct(p){
    productId.value = p.id;
    pName.value = p.name;
    pDescription.value = p.description;
    pPrice.value = p.price;
    pCurrency.value = p.currency;
  }
  async function deleteProduct(id){
    if(confirm('¿Eliminar producto?')){
      await fetch(apiBase + '/products/'+id, {method:'DELETE'});
      loadProducts();
    }
  }
  document.getElementById('productForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const body = {
      name: pName.value,
      description: pDescription.value,
      price: parseFloat(pPrice.value),
      currency: pCurrency.value,
      available: true
    };
    if(productId.value){
      await fetch(apiBase + '/products/'+productId.value, {
        method: 'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
    } else {
      await fetch(apiBase + '/products', {
        method: 'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
    }
    productForm.reset();
    loadProducts();
  });

  // PLANTILLAS
  async function loadTemplates(){
    const res = await fetch(apiBase + '/admin/templates');
    const templates = await res.json();
    const tbody = document.getElementById('templateTable');
    tbody.innerHTML = '';
    templates.forEach(t=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t.name}</td><td>${t.templateText}</td>
                    <td>${t.active?'Sí':'No'}</td>
                    <td>
                      <button class="btn btn-sm btn-warning" onclick='editTemplate(${JSON.stringify(t)})'>Editar</button>
                      <button class="btn btn-sm btn-danger" onclick='deleteTemplate(${t.id})'>Eliminar</button>
                    </td>`;
      tbody.appendChild(tr);
    });
  }
  function editTemplate(t){
    templateId.value = t.id;
    tName.value = t.name;
    tText.value = t.templateText;
    tActive.checked = t.active;
  }
  async function deleteTemplate(id){
    if(confirm('¿Eliminar plantilla?')){
      await fetch(apiBase + '/admin/templates/'+id, {method:'DELETE'});
      loadTemplates();
    }
  }
  document.getElementById('templateForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const body = {
      name: tName.value,
      templateText: tText.value,
      active: tActive.checked
    };
    if(templateId.value){
      await fetch(apiBase + '/admin/templates/'+templateId.value, {
        method: 'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
    } else {
      await fetch(apiBase + '/admin/templates', {
        method: 'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
    }
    templateForm.reset();
    loadTemplates();
  });

  // INIT
  loadSettings();
  loadProducts();
  loadTemplates();
</script>
</body>
</html>
