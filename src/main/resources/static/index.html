<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <title>Pedido WhatsApp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        body{font-family:system-ui,Arial,sans-serif;max-width:860px;margin:20px auto;padding:0 16px}
        header{display:flex;justify-content:space-between;align-items:center}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
        .card{border:1px solid #ddd;border-radius:12px;padding:12px}
        .row{display:flex;gap:8px;align-items:center}
        input,button,select{padding:8px;border-radius:8px;border:1px solid #ccc}
        button{cursor:pointer}
        .right{text-align:right}
        .muted{color:#666}
    </style>
</head>
<body>
<header>
    <h1 id="store">Mi Tienda</h1>
    <div class="muted" id="currency">CLP</div>
</header>

<section class="grid" id="products"></section>

<h3>Carrito</h3>
<div id="cart"></div>

<h3>Datos</h3>
<div class="row">
    <input id="name" placeholder="Nombre"/>
    <input id="phone" placeholder="56912345678"/>
</div>
<div class="row">
    <input id="address" placeholder="Dirección (opcional)"/>
    <select id="delivery">
        <option value="NONE">Sin entrega</option>
        <option value="PICKUP">Retiro</option>
        <option value="DELIVERY">Delivery</option>
    </select>
</div>
<div class="row">
    <input id="note" placeholder="Nota (opcional)" style="flex:1"/>
</div>

<div class="right" style="margin-top:12px;">
    <button onclick="generate()">Generar WhatsApp</button>
</div>

<script>
    let catalog, cart = {};

    async function loadCatalog(){
        const res = await fetch('/api/v1/public/catalog');
        catalog = await res.json();
        document.getElementById('store').textContent = catalog.storeName;
        document.getElementById('currency').textContent = catalog.currency;
        const cont = document.getElementById('products');
        cont.innerHTML = '';
        catalog.products.forEach(p=>{
            const div = document.createElement('div');
            div.className='card';
            div.innerHTML = `
      <b>${p.name}</b>
      <div class="muted">${p.description ?? ''}</div>
      <div><b>${p.price} ${catalog.currency}</b></div>
      <div class="row">
        <input type="number" min="1" value="1" id="q-${p.id}" style="width:80px"/>
        <button onclick="add(${p.id})">Agregar</button>
      </div>`;
            cont.appendChild(div);
        });
    }
    function add(id){
        const q = parseInt(document.getElementById('q-'+id).value || '1',10);
        cart[id] = (cart[id]||0)+q;
        renderCart();
    }
    function remove(id){
        delete cart[id];
        renderCart();
    }
    function renderCart(){
        const c = document.getElementById('cart');
        const items = Object.entries(cart);
        if(items.length===0){ c.innerHTML = '<i class="muted">Sin productos</i>'; return; }
        c.innerHTML = '';
        items.forEach(([id,q])=>{
            const p = catalog.products.find(x=>x.id==id);
            const div = document.createElement('div');
            div.className='row';
            div.innerHTML = `<div style="flex:1">${p.name} x ${q}</div>
                     <button onclick="remove(${id})">Quitar</button>`;
            c.appendChild(div);
        });
    }
    async function generate(){
        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        if(!name || !phone){ alert('Nombre y teléfono son obligatorios'); return; }
        const address = document.getElementById('address').value.trim();
        const delivery = document.getElementById('delivery').value;
        const note = document.getElementById('note').value.trim();

        const items = Object.entries(cart).map(([id,q])=>({productId: Number(id), quantity: q}));
        if(items.length===0){ alert('Agrega productos'); return; }

        const body = { customerName:name, customerPhone:phone, address, deliveryMode:delivery, note, items };
        const res = await fetch('/api/v1/public/order/generate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        const data = await res.json();
        if(data.whatsAppLink){ window.location.href = data.whatsAppLink; }
        else{ alert('Pedido generado:\n'+data.generatedText); }
    }
    loadCatalog();
</script>
</body>
</html>
